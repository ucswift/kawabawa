/*
 * RailsAdmin Timeline @VERSION
 *
 * License
 *
 * http://www.railsadmin.org
 *
 * Depends:
 *   jquery.ui.core.js
 *   jquery.ui.widget.js
 *   jquery.ui.draggable.js
 */
(function(a){a.widget("ra.timeline",{options:{date:new Date,monthChanged:function(a,b){},months:["January","February","March","April","May","June","July","August","September","October","November","December"],range:4,url:null},_create:function(){this.options.url||alert("Timeline widget needs to be initialized with url option"),this._build(),this._bindEvents(),this.refresh()},_build:function(){this.element.addClass("ra-timeline"),this.next=a('<a class="range next" href="javascript:void();">Next</a>').appendTo(this.element),this.previous=a('<a class="range previous" href="javascript:void();">Previous</a>').appendTo(this.element),this.months=a("<ul></ul>").appendTo(this.element),this.handle=a('<div class="handle"></div>').appendTo(this.element),this.handleOffset=parseInt(this.element.css("padding-left"),10),this._moveHandleToRight()},_bindEvents:function(){var b=0,c=this;a(window).resize(function(){c.redraw()}),this.handle.draggable({axis:"x",containment:this.element,drag:function(d,e){var f=Math.floor((e.position.left-c.handleOffset)/c.monthWidth);if(f!==b){b=f;var g=a(c.months.children().get(f)),h=g.attr("data-month"),i=g.attr("data-year");c.options.monthChanged(h,i)}}}),this.previous.bind("click.timeline",function(a){a.preventDefault(),c.options.date.setMonth(c.options.date.getMonth()-c.options.range),c._moveHandleToRight(),c.options.monthChanged(c.options.date.getMonth()+1,c.options.date.getFullYear()),c.refresh()}),this.next.bind("click.timeline",function(a){a.preventDefault();var b=c._getNextMonthDate();c.options.monthChanged(b.getMonth()+1,b.getFullYear()),c.options.date.setMonth(c.options.date.getMonth()+c.options.range),c._moveHandleToLeft(),c.refresh()})},_getCurrentDate:function(){return new Date(this.options.date.getFullYear(),this.options.date.getMonth(),1)},_getNextMonthDate:function(){var a=this._getCurrentDate();return a.setMonth(this.options.date.getMonth()+1),a},_getPreviousMonthDate:function(){var a=this._getCurrentDate();return a.setMonth(this.options.date.getMonth()-1),a},_moveHandleToLeft:function(){this.handle.css("left",this.handleOffset)},_moveHandleToRight:function(){this.handle.css("left",this.months.width()-this.handle.width()+this.handleOffset)},redraw:function(){this.months.find("li").remove();var a=this.options.range,b=this._getCurrentDate();this.monthWidth=Math.floor(this.months.width()/this.options.range)-1;while(a--)this.months.prepend('<li style="width:'+this.monthWidth+'px" data-year="'+b.getFullYear()+'" data-month="'+(parseInt(b.getMonth(),10)+1)+'">'+'<span class="month">'+this.getMonthName(b)+"</span>"+'<span class="bar"><span></span></span>'+"</li>"),b.setMonth(b.getMonth()-1);this._moveHandleToRight()},refresh:function(){this.redraw();var b=this,c=this._getCurrentDate();a.ajax({url:this.options.url,data:{from:{month:c.getMonth()+1-this.options.range,year:c.getFullYear()},to:{month:this.options.date.getMonth()+1,year:this.options.date.getFullYear()}},beforeSend:function(a){a.setRequestHeader("Accept","application/json")},success:function(c,d,e){var f=b.months.find(".bar").first().height(),g=0,h=function(a){return b.months.find("li[data-year="+a.year+"][data-month="+a.month+"] .bar span").first()};a(c).each(function(a,b){h(b.history).length&&b.history.record_count>g&&(g=b.history.record_count)}),a(c).each(function(a,c){var d="",e=h(c.history),i=0,j=0;e.length&&(c.history.record_count>0&&(j=parseFloat(c.history.record_count/g),d=b.getBarClass(j),i=Math.floor(f*j)),e.toggleClass(d,300).animate({height:i},1e3,"easeOutBounce"))})},error:function(a,b,c){dialog.html(a.responseText)}})},getBarClass:function(a){return a<.33?"low":a<.67?"medium":"high"},getMonthName:function(a){return this.options.months[a.getMonth()]}})})(jQuery)